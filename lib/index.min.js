!function(){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r})(e)}function e(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function t(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function n(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),t.push.apply(t,n)}return t}function o(r){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?n(Object(o),!0).forEach((function(e){t(r,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(o,e))}))}return r}function a(r,e){return function(r){if(Array.isArray(r))return r}(r)||function(r,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(r)))return;var t=[],n=!0,o=!1,a=void 0;try{for(var i,u=r[Symbol.iterator]();!(n=(i=u.next()).done)&&(t.push(i.value),!e||t.length!==e);n=!0);}catch(r){o=!0,a=r}finally{try{n||null==u.return||u.return()}finally{if(o)throw a}}return t}(r,e)||function(r,e){if(!r)return;if("string"==typeof r)return i(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);"Object"===t&&r.constructor&&(t=r.constructor.name);if("Map"===t||"Set"===t)return Array.from(r);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return i(r,e)}(r,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(r,e){(null==e||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}var u=require("lodash/isEqual"),f=require("lodash/isInteger"),s=require("lodash/has"),l=require("lodash/size"),c=require("lodash/reduce"),d=require("lodash/reverse"),O=require("lodash/keys"),_=require("lodash/values"),P=require("lodash/castArray"),T=require("lodash/pick"),A=require("lodash/pickBy"),y=require("lodash/get"),E=require("lodash/set"),$=require("lodash/nth"),h=require("lodash/omit"),p=require("lodash/omitBy"),N=require("lodash/groupBy"),v=require("lodash/sortBy"),R=require("lodash/filter"),w=require("lodash/map"),I=require("lodash/mapValues"),g=require("lodash/find"),b=require("lodash/findIndex"),M=require("@genx/error"),L=M.ValidationError,S=M.InvalidArgument,m=require("@genx/july"),V=m.remap,D=m.isPlainObject,q=require("./config");q.messages||require("./locale/msg.en-US")();var C=q.messages,j=["$has","$match","$all"],U=["$eval","$apply"];function Y(r,e,t,n,o,a){return a&&a.$$ERROR?a.$$ERROR:(C.validationErrors[r]||C.validationErrors.OP_MATCH)(e,t,n,o)}function H(r,e,t,n,o){var a=q.getValidator(e);if(!a)throw new S(C.INVALID_VALIDATOR_HANDLER(e));return a(r,t,n,o)}function x(r,e,t,n){var o=q.getProcessor(e);if(!o)throw new S(C.INVALID_PROCESSOR_HANDLER(e));return o(r,t,n)}function G(r,e,t,n,o){return t[1]?e?x(r,t[0],n):r:function(r,e,t,n,o){var a=q.getProcessor(e);if(!a)throw new S(C.INVALID_PROCESSOR_HANDLER(e));return a(r,t,n,o)}(r,t[0],e,n,o)}function B(r,e,t,n,o){var a={};switch(e){case"|>":var i=b(r,(function(r){return!H(r,t,n,o,a)}));if(i)return[!1,Y(t,i,r[i],n,o,a)];break;case"|*":if(!g(r,(function(r){return H(r,t,n,o,a)})))return[!1,Y(t,null,r,n,o,a)];break;default:throw new S(C.INVALID_COLLECTION_OP(e))}}function X(r,e,t,n,a,i){switch(e){case"|>":return(Array.isArray(r)?w:I)(r,(function(e,u){return G(e,n,t,C.formatPrefix(u,a),o(o({},i),{},{$$PARENT:r,$$CURRENT:e}))}));default:throw new S(C.INVALID_COLLECTION_OP(e))}}function k(e,t,n){var o=!1;if(!D(t))return H(e,"OP_EQUAL",t,n)?[!0]:[!1,C.validationErrors.OP_EQUAL(null,e,t,n)];for(var i in t){var u=t[i],f=i.length;if(f>1){if(f>3&&"|"===i[0]&&"$"===i[2]){var s=i.substr(0,2);i=i.substr(2);var l=q.getValidatorTag(i);if(!l)throw new S(C.INVALID_VALIDATION_OP(i));var c=B(e,s,l,u,n);if(c)return c;continue}if("$"===i[0]){var d=q.getValidatorTag(i);if(!d)throw new S(C.INVALID_VALIDATION_OP(i));var O={};if(!H(e,d,u,n,O))return[!1,Y(d,null,e,u,n,O)];continue}}if(!o){if(null==e)return[!1,C.validationErrors.OP_EXISTS(null,null,!0,n)];var _=r(e);if("object"!==_)return[!1,C.validationErrors.OP_TYPE(null,_,"object",n)]}o=!0;var P=y(e,i);if(null!=u&&"object"===r(u)){var T=a(k(P,u,C.formatPrefix(i,n)),2),A=T[0],E=T[1];if(!A)return[!1,E]}else if(!H(P,"OP_EQUAL",u,n))return[!1,C.validationErrors.OP_EQUAL(i,P,u,n)]}return[!0]}function Q(e,t,n,a,i){if(Array.isArray(t))return i?t.map((function(r){return Q(void 0,r,n,o({},a),!0)})):t.reduce((function(r,e){return Q(r,e,n,o({},a))}),e);var u=r(t);if("boolean"===u)return i?t:t?e:void 0;if("number"===u||"bigint"===u){if(i)return t;throw new S(C.SYNTAX_NUMBER_AS_EXPR)}if("string"===u){if(t.startsWith("$$")){var f=t.indexOf(".");return-1===f?a[t]:y(a[t.substr(0,f)],t.substr(f+1))}if(i)return t;var s=q.getProcessorTagAndType(t);if(!s)throw new S(C.INVALID_PROCESSING_OP(t));if(!s[1])throw new S(C.REQUIRE_RIGHT_OPERAND(t));return x(e,s[0],n)}if("object"!==u)throw new S(C.SYNTAX_INVALID_EXPR);if(i)return I(t,(function(r){return Q(void 0,r,n,a,!0)}));null==a&&(a={$$ROOT:e,$$PARENT:null,$$CURRENT:e});var l,c=!1;for(var d in t){var O=t[d],_=d.length;if(_>1){if("$"===d[0]){if(l)throw new S(C.SYNTAX_OP_NOT_ALONE);var P=q.getProcessorTagAndType(d);if(!P)throw new S(C.INVALID_PROCESSING_OP(d));if(c)throw new S(C.SYNTAX_OP_NOT_ALONE);l=G(e,O,P,n,a),c=!0;continue}if(_>3&&"|"===d[0]&&"$"===d[2]){if(l)throw new S(C.SYNTAX_OP_NOT_ALONE);var T=d.substr(0,2);d=d.substr(2);var A=q.getProcessorTagAndType(d);if(!A)throw new S(C.INVALID_PROCESSING_OP(d));if(c)throw new S(C.SYNTAX_OP_NOT_ALONE);l=X(e,T,A,O,n,a),c=!0;continue}}if(c)throw new S(C.SYNTAX_OP_NOT_ALONE);var $=-1!==d.indexOf("."),h=Q(null!=e?$?y(e,d):e[d]:void 0,O,C.formatPrefix(d,n),a);void 0!==h&&(null==l&&(l={}),$?E(l,d,h):l[d]=h)}return l}q.addValidatorToMap(["$eq","$eql","$equal"],"OP_EQUAL",(function(r,e){return u(r,e)})),q.addValidatorToMap(["$ne","$neq","$notEqual"],"OP_NOT_EQUAL",(function(r,e){return!u(r,e)})),q.addValidatorToMap(["$not"],"OP_NOT",(function(r){for(var e=arguments.length,t=new Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];return!H.apply(void 0,[r,"OP_MATCH"].concat(t))})),q.addValidatorToMap(["$gt","$>","$greaterThan"],"OP_GREATER_THAN",(function(r,e){return r>e})),q.addValidatorToMap(["$gte","$>=","$greaterThanOrEqual"],"OP_GREATER_THAN_OR_EQUAL",(function(r,e){return r>=e})),q.addValidatorToMap(["$lt","$<","$lessThan"],"OP_LESS_THAN",(function(r,e){return r<e})),q.addValidatorToMap(["$lte","$<=","$lessThanOrEqual"],"OP_LESS_THAN_OR_EQUAL",(function(r,e){return r<=e})),q.addValidatorToMap(["$in"],"OP_IN",(function(r,e){if(null==e)return!1;if(!Array.isArray(e))throw new S(C.OPERAND_NOT_ARRAY("OP_IN"));var t=q.getValidator("OP_EQUAL");return e.find((function(e){return t(r,e)}))})),q.addValidatorToMap(["$nin","$notIn"],"OP_NOT_IN",(function(r,e){if(null==e)return!0;if(!Array.isArray(e))throw new S(C.OPERAND_NOT_ARRAY("OP_NOT_IN"));var t=q.getValidator("OP_NOT_EQUAL");return e.every((function(e){return t(r,e)}))})),q.addValidatorToMap(["$exist","$exists","$notNull"],"OP_EXISTS",(function(r,e){if("boolean"!=typeof e)throw new S(C.OPERAND_NOT_BOOL("OP_EXISTS"));return e?null!=r:null==r})),q.addValidatorToMap(j,"OP_MATCH",(function(r,e,t,n){if(Array.isArray(e))return e.every((function(e){return k(r,e,t)[0]}));var o=k(r,e,t),a=o[0];return!a&&n&&(n.$$ERROR=o[1]),a})),q.addValidatorToMap(["$any","$or","$either"],"OP_MATCH_ANY",(function(r,e,t,n){if(!Array.isArray(e))throw new S(C.OPERAND_NOT_ARRAY("OP_MATCH_ANY"));return!!e.find((function(e){var o=k(r,e,t),a=o[0];return!a&&n&&(n.$$ERROR=o[1]),a}))})),q.addValidatorToMap(["$is","$typeOf"],"OP_TYPE",(function(e,t){if("string"!=typeof t)throw new S(C.OPERAND_NOT_STRING("OP_TYPE"));return"array"===(t=t.toLowerCase())?Array.isArray(e):"integer"===t?f(e):"text"===t?"string"==typeof e:r(e)===t})),q.addValidatorToMap(["$hasKey","$hasKeys","$withKey","$withKeys"],"OP_HAS_KEYS",(function(e,t){return"object"===r(e)&&(Array.isArray(t)?t.every((function(r){return s(e,r)})):s(e,t))})),q.addValidatorToMap(["$startWith","$startsWith"],"OP_START_WITH",(function(r,e){if("string"!=typeof r)return!1;if("string"!=typeof e)throw new S(C.OPERAND_NOT_STRING("OP_START_WITH"));return r.startsWith(e)})),q.addValidatorToMap(["$endWith","$endsWith"],"OP_END_WITH",(function(r,e){if("string"!=typeof r)return!1;if("string"!=typeof e)throw new S(C.OPERAND_NOT_STRING("OP_END_WITH"));return r.endsWith(e)})),q.addValidatorToMap(U,"OP_EVAL",(function(r,e,t,n){if(!Array.isArray(e)||2!==e.length)throw new S(C.OPERAND_NOT_TUPLE("OP_EVAL"));var o=k(Q(r,e[0],t),e[1],t),a=o[0];return!a&&n&&(n.$$ERROR=o[1]),a})),q.addProcessorToMap(["$size","$length","$count"],"OP_SIZE",!0,(function(r){return l(r)})),q.addProcessorToMap(["$sum","$total"],"OP_SUM",!0,(function(r){return c(r,(function(r,e){return r+=e}),0)})),q.addProcessorToMap(["$keys"],"OP_KEYS",!0,(function(r){return O(r)})),q.addProcessorToMap(["$values"],"OP_VALUES",!0,(function(r){return _(r)})),q.addProcessorToMap(["$type"],"OP_GET_TYPE",!0,(function(e){return Array.isArray(e)?"array":f(e)?"integer":r(e)})),q.addProcessorToMap(["$reverse"],"OP_REVERSE",!0,(function(r){return d(r)})),q.addProcessorToMap(["$add","$plus","$inc"],"OP_ADD",!1,(function(r,e){return r+e})),q.addProcessorToMap(["$sub","$subtract","$minus","$dec"],"OP_SUB",!1,(function(r,e){return r-e})),q.addProcessorToMap(["$mul","$multiply","$times"],"OP_MUL",!1,(function(r,e){return r*e})),q.addProcessorToMap(["$div","$divide"],"OP_DIV",!1,(function(r,e){return r/e})),q.addProcessorToMap(["$set","$=","$value"],"OP_SET",!1,(function(r,e,t,n){return Q(void 0,e,t,n,!0)})),q.addProcessorToMap(["$addItem","$override"],"OP_ADD_ITEM",!1,(function(e,n,a,i){if("object"!==r(e))throw new S(C.VALUE_NOT_COLLECTION("OP_ADD_ITEM"));if(Array.isArray(e))return e.concat(n);if(!Array.isArray(n)||2!==n.length)throw new S(C.OPERAND_NOT_TUPLE("OP_ADD_ITEM"));return o(o({},e),{},t({},n[0],Q(e,n[1],a,o(o({},i),{},{$$PARENT:i.$$CURRENT,$$CURRENT:e}))))})),q.addProcessorToMap(["$pick"],"OP_PICK",!1,(function(e,t,n){return null==e?null:("object"!==r(t)&&(t=P(t)),Array.isArray(t)?T(e,t):A(e,(function(r,e){return k(e,t,C.formatPrefix(e,n))[0]})))})),q.addProcessorToMap(["$at","$getByIndex","$nth"],"OP_GET_BY_INDEX",!1,(function(r,e){return $(r,e)})),q.addProcessorToMap(["$of","$getByKey"],"OP_GET_BY_KEY",!1,(function(r,e){return y(r,e)})),q.addProcessorToMap(["$omit"],"OP_OMIT",!1,(function(e,t,n){return null==e?null:("object"!==r(t)&&(t=P(t)),Array.isArray(t)?h(e,t):p(e,(function(r,e){return k(e,t,C.formatPrefix(e,n))[0]})))})),q.addProcessorToMap(["$group","$groupBy"],"OP_GROUP",!1,(function(r,e){return N(r,e)})),q.addProcessorToMap(["$sort","$orderBy","$sortBy"],"OP_SORT",!1,(function(r,e){return v(r,e)})),q.addProcessorToMap(U,"OP_EVAL",!1,Q),q.addProcessorToMap(["$merge"],"OP_MERGE",!1,(function(r,e,t,n){if(!Array.isArray(e))throw new S(C.OPERAND_NOT_ARRAY("OP_MERGE"));return e.reduce((function(e,a,i){return Object.assign(e,Q(r,a,C.formatPrefix(i,t),o({},n)))}),{})})),q.addProcessorToMap(["$filter","$select"],"OP_FILTER",!1,(function(e,t,n){if(null==e)return null;if("object"!==r(e))throw new S(C.VALUE_NOT_COLLECTION("OP_FILTER"));return R(e,(function(r,e){return H(r,"OP_MATCH",t,C.formatPrefix(e,n))}))})),q.addProcessorToMap(["$remap"],"OP_REMAP",!1,(function(e,t){if(null==e)return null;if("object"!==r(e))throw new S(C.VALUE_NOT_COLLECTION("OP_REMAP"));return V(e,t)})),q.addProcessorToMap(["$if"],"OP_IF",!1,(function(r,e,t,n){if(!Array.isArray(e))throw new S(C.OPERAND_NOT_ARRAY("OP_IF"));if(e.length<2||e.length>3)throw new S(C.OPERAND_NOT_TUPLE_2_OR_3("OP_IF"));return H(r,"OP_MATCH",Q(void 0,e[0],t,n,!0),t)?Q(r,e[1],t,n):e.length>2?Q(r,e[2],t,n):r})),q.addProcessorToMap(j,"OP_MATCH",!1,(function(r,e,t){return H(r,"OP_MATCH",e,t)}));var W=function(){function r(e){!function(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),this.value=e}var t,n,o;return t=r,(n=[{key:"match",value:function(r){var e=k(this.value,r);if(e[0])return this;throw new L(e[1],{actual:this.value,expected:r})}},{key:"evaluate",value:function(r){return Q(this.value,r)}},{key:"update",value:function(r){return this.value=Q(this.value,r),this}}])&&e(t.prototype,n),o&&e(t,o),r}();t(W,"config",q),t(W,"match",k),t(W,"evaluate",Q),module.exports=W}();
