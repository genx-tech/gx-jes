{"version":3,"file":"validate.js","names":["MSG","config","messages","getUnmatchedExplanation","op","leftValue","rightValue","context","$$ERROR","validationErrors","Error","getter","name","invalidType","value","type","options","reason","ops","TYPE","throwError","ValidationError","path","plainError","test","left","right","handler","getValidator","INVALID_TEST_HANLDER","validate","actual","expectedJES","abortEarly","length","SYNTAX_INVALID_EXPR","asPredicate","errors","_options","operator","_context","opValue","getValidatorTag","UNSUPPORTED_VALIDATION_OP","fieldName","complexKey","indexOf","_get","undefined","getChildContext","isPlainObject","MATCH","EQUAL","push"],"sources":["../src/validate.js"],"sourcesContent":["// JSON Expression Syntax (JES) for validation\nimport ValidationError from './ValidationError';\nimport config, { getChildContext } from './config';\nimport ops from './validateOperators';\nimport { isPlainObject, get as _get } from '@genx/july';\n\nconst MSG = config.messages;\n\nfunction getUnmatchedExplanation(op, leftValue, rightValue, context) {\n    if (context.$$ERROR) {\n        return context.$$ERROR;\n    }\n\n    if (!MSG.validationErrors) {\n        throw new Error('Please import locale first before using validators.');\n    }\n    const getter = MSG.validationErrors[op];\n    return getter(context.name, leftValue, rightValue, context);\n}\n\nexport function invalidType(value, type, options, context) {\n    const reason = MSG.validationErrors[ops.TYPE](context.name, value, type, context);\n\n    if (options.throwError) {\n        throw new ValidationError(reason, value, context.path);\n    }\n\n    return options.plainError ? reason : new ValidationError(reason, value, context.path);\n}\n\nexport function test(left, op, right, options, context) {\n    const handler = config.getValidator(op);\n\n    if (!handler) {\n        throw new Error(MSG.INVALID_TEST_HANLDER(op));\n    }\n\n    return handler(left, right, options, context);\n}\n\n/**\n * Validate the given object with JSON Expression Syntax (JES)\n * @param {*} actual - The object to match\n * @param {*} expectedJES - Expected state in JSON Expression Syntax\n * @param {*} options - Validation options\n * @param {*} context - Validation context\n * @returns {array} - [ {boolean} matched, {string} unmatchedReason ]\n */\nfunction validate(actual, expectedJES, options = { throwError: true, abortEarly: true }, context = {}) {\n    const type = typeof expectedJES;\n\n    if (type === 'string') {\n        if (expectedJES.length === 0 || expectedJES[0] !== '$') {\n            throw new Error(MSG.SYNTAX_INVALID_EXPR(expectedJES));\n        }\n\n        return validate(actual, { [expectedJES]: null }, options, context);\n    }\n\n    const { throwError, abortEarly, asPredicate, plainError } = options;\n\n    if (expectedJES == null) {\n        return true;\n    }\n\n    let { path } = context;\n    const errors = [];\n    const _options = !abortEarly && throwError ? { ...options, throwError: false } : options;\n\n    for (let operator in expectedJES) {\n        let op, left, _context;\n\n        const opValue = expectedJES[operator];\n\n        if (\n            // $match\n            (operator.length > 1 && operator[0] === '$') ||\n            // |>$all\n            (operator.length > 3 && operator[0] === '|' && operator[2] === '$')\n        ) {\n            //validator\n            op = config.getValidatorTag(operator);\n            if (!op) {\n                throw new Error(MSG.UNSUPPORTED_VALIDATION_OP(operator, path));\n            }\n\n            left = actual;\n            _context = context;\n        } else {\n            const fieldName = operator;\n            let complexKey = fieldName.indexOf('.') !== -1;\n\n            //pick a field and then apply manipulation\n            left = actual != null ? (complexKey ? _get(actual, fieldName) : actual[fieldName]) : undefined;\n\n            _context = getChildContext(context, actual, fieldName, left);\n\n            if (opValue != null && isPlainObject(opValue)) {\n                op = ops.MATCH;\n            } else {\n                op = ops.EQUAL;\n            }\n        }\n\n        if (!test(left, op, opValue, _options, _context)) {\n            if (asPredicate) {\n                return false;\n            }\n\n            const reason = getUnmatchedExplanation(op, left, opValue, _context);\n            if (abortEarly && throwError) {\n                throw new ValidationError(reason, left, _context.path);\n            }\n\n            errors.push(plainError ? reason : new ValidationError(reason, left, _context.path));\n            if (abortEarly) {\n                break;\n            }\n        }\n    }\n\n    if (errors.length > 0) {\n        if (asPredicate) {\n            return false;\n        }\n\n        if (throwError) {\n            throw new ValidationError(errors, actual, path);\n        }\n\n        return errors.length === 1 && plainError ? errors[0] : errors;\n    }\n\n    return true;\n}\n\nexport default validate;\n"],"mappings":"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"}