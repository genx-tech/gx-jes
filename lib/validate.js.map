{"version":3,"file":"validate.js","names":["_ValidationError","_interopRequireDefault","require","_config","_interopRequireWildcard","_validateOperators","_july","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","MSG","config","messages","getUnmatchedExplanation","op","leftValue","rightValue","context","$$ERROR","validationErrors","Error","getter","name","invalidType","value","type","options","reason","ops","TYPE","throwError","ValidationError","path","plainError","test","left","right","handler","getValidator","INVALID_TEST_HANLDER","validate","actual","expectedJES","abortEarly","length","SYNTAX_INVALID_EXPR","startsWith","$equal","asPredicate","errors","_options","operator","_context","opValue","getValidatorTag","UNSUPPORTED_VALIDATION_OP","fieldName","complexKey","indexOf","_get","undefined","getChildContext","isPlainObject","MATCH","EQUAL","push","_default","exports"],"sources":["../src/validate.js"],"sourcesContent":["// JSON Expression Syntax (JES) for validation\nimport ValidationError from './ValidationError';\nimport config, { getChildContext } from './config';\nimport ops from './validateOperators';\nimport { isPlainObject, get as _get } from '@genx/july';\n\nconst MSG = config.messages;\n\nfunction getUnmatchedExplanation(op, leftValue, rightValue, context) {\n    if (context.$$ERROR) {\n        return context.$$ERROR;\n    }\n\n    if (!MSG.validationErrors) {\n        throw new Error('Please import locale first before using validators.');\n    }\n    const getter = MSG.validationErrors[op];\n    return getter(context.name, leftValue, rightValue, context);\n}\n\nexport function invalidType(value, type, options, context) {\n    const reason = MSG.validationErrors[ops.TYPE](context.name, value, type, context);\n\n    if (options.throwError) {\n        throw new ValidationError(reason, value, context.path);\n    }\n\n    return options.plainError ? reason : new ValidationError(reason, value, context.path);\n}\n\nexport function test(left, op, right, options, context) {\n    const handler = config.getValidator(op);\n\n    if (!handler) {\n        throw new Error(MSG.INVALID_TEST_HANLDER(op));\n    }\n\n    return handler(left, right, options, context);\n}\n\n/**\n * Validate the given object with JSON Expression Syntax (JES)\n * @param {*} actual - The object to match\n * @param {*} expectedJES - Expected state in JSON Expression Syntax\n * @param {*} options - Validation options\n * @param {*} context - Validation context\n * @returns {array} - [ {boolean} matched, {string} unmatchedReason ]\n */\nfunction validate(actual, expectedJES, options = { throwError: true, abortEarly: true }, context = {}) {\n    const type = typeof expectedJES;\n\n    if (type === 'string') {\n        if (expectedJES.length === 0 || expectedJES[0] !== '$') {\n            throw new Error(MSG.SYNTAX_INVALID_EXPR(expectedJES));\n        }\n\n        if (expectedJES.startsWith('$$')) {\n            return validate(actual, { $equal: expectedJES }, options, context); \n        }\n\n        return validate(actual, { [expectedJES]: null }, options, context);\n    }\n\n    const { throwError, abortEarly, asPredicate, plainError } = options;\n\n    if (expectedJES == null) {\n        return true;\n    }\n\n    if (type !== 'object') {\n        throw new Error(MSG.SYNTAX_INVALID_EXPR(expectedJES));\n    }\n\n    let { path } = context;\n    const errors = [];\n    const _options = !abortEarly && throwError ? { ...options, throwError: false } : options;\n\n    for (let operator in expectedJES) {\n        let op, left, _context; \n\n        const opValue = expectedJES[operator];\n\n        if (\n            // $match\n            (operator.length > 1 && operator[0] === '$') ||\n            // |>$all\n            (operator.length > 3 && operator[0] === '|' && operator[2] === '$')\n        ) {\n            //validator\n            op = config.getValidatorTag(operator);\n            if (!op) {\n                throw new Error(MSG.UNSUPPORTED_VALIDATION_OP(operator, path));\n            }\n\n            left = actual;\n            _context = context;\n        } else {\n            const fieldName = operator;\n            let complexKey = fieldName.indexOf('.') !== -1;\n\n            //pick a field and then apply manipulation\n            left = actual != null ? (complexKey ? _get(actual, fieldName) : actual[fieldName]) : undefined;\n\n            _context = getChildContext(context, actual, fieldName, left);\n\n            if (opValue != null && isPlainObject(opValue)) {\n                op = ops.MATCH;\n            } else {\n                op = ops.EQUAL;\n            }\n        }\n\n        if (!test(left, op, opValue, _options, _context)) {\n            if (asPredicate) {\n                return false;\n            }\n\n            const reason = getUnmatchedExplanation(op, left, opValue, _context);\n            if (abortEarly && throwError) {\n                throw new ValidationError(reason, left, _context.path);\n            }\n\n            errors.push(plainError ? reason : new ValidationError(reason, left, _context.path));\n            if (abortEarly) {\n                break;\n            }\n        }\n    }\n\n    if (errors.length > 0) {\n        if (asPredicate) {\n            return false;\n        }\n\n        if (throwError) {\n            throw new ValidationError(errors, actual, path);\n        }\n\n        return errors.length === 1 && plainError ? errors[0] : errors;\n    }\n\n    return true;\n}\n\nexport default validate;\n"],"mappings":"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"}